<html>
    <head>
        <meta charset="utf-8"/>
        <title>Jogo Multiplayer</title>

        <style>
            #screen{
                border: 10px solid #ccc;
                image-rendering: pixelated;
                image-rendering: crisp-edges;
                image-rendering: -moz-crisp-edges;
                width: 400px;
                height: 400px;
            }
        </style>
    </head>

    <body>
        <canvas id="screen" width="10" height="10"></canvas>
    </body>
      
    <script>
        const screen = document.getElementById("screen");
        const context = screen.getContext("2d")

        function createGame() {

            const state = { 

                players: {
                    'player1': {x:0, y:0},
                    'player2': {x:5, y:0}
                },

                fruits: {
                    'fruit1':{x:5, y:5}
                },
            }

            const acceptedMoves = {

                ArrowDown(player){
                    player.y = player.y + 1
                },

                ArrowUp(player){
                    player.y = player.y - 1
                },

                ArrowRight(player){
                    player.x = player.x + 1
                },

                ArrowLeft(player){
                    player.x = player.x - 1
                }
            }

            function movePlayer(command){

                var move = acceptedMoves[command.keyPressed];
                var player = game.state.players[command.playerId];
                
                if(move){
                    move(player);
                }
            }
            
            return { movePlayer, state }
        }
        
        function createKeybordListener(){
            
            const state = {
                observers: []
            };

            function subscribe(observerFunction) {
                
                state.observers.push(observerFunction);
            };

            function notifyAll(command) {
                console.log(`notifying ${state.observers.length} observers`);

                for (const observerFunction of state.observers) {
                    observerFunction(command)
                };
            };

            document.addEventListener("keydown", handleKeydown);
        
            function handleKeydown(event) {

                const command = {
                    playerId : 'player1',
                    keyPressed : event.key
                };

                notifyAll(command)
            };

            return { subscribe };
        }
        
        const game = createGame();
        const keyboardListener = createKeybordListener()
        keyboardListener.subscribe(game.movePlayer)

        renderScreen()

        function renderScreen(){

            context.clearRect(0, 0, screen.width, screen.height);  

            for (const playerId in game.state.players) {

                const player = game.state.players[playerId];
                context.fillStyle = "gray";
                context.fillRect(player.x, player.y, 1, 1);            
            }

            for (const fruitId in game.state.fruits) {

                const fruit = game.state.fruits[fruitId];
                context.fillStyle = "green";
                context.fillRect(fruit.x, fruit.y, 1, 1);            
            }

            requestAnimationFrame(renderScreen)
        }
        
    </script>
</html>